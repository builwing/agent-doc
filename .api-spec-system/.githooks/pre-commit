#!/bin/bash

# API Specification System - Pre-commit Hook
# ä»•æ§˜æº–æ‹ ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ã‚³ãƒŸãƒƒãƒˆã‚’è¨±å¯

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}ğŸ” API Specification Compliance Check${NC}"
echo "========================================="

# 1. Check if spec files have been modified
SPEC_CHANGED=false
if git diff --cached --name-only | grep -q "specs/.*\.yaml\|specs/.*\.yml"; then
    SPEC_CHANGED=true
    echo -e "${YELLOW}ğŸ“ APIä»•æ§˜æ›¸ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™${NC}"
fi

# 2. Check if generated files have been manually edited
GENERATED_EDITED=false
if git diff --cached --name-only | grep -q "generated/"; then
    GENERATED_EDITED=true
    echo -e "${RED}âš ï¸  è­¦å‘Š: generated/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™${NC}"
    echo "ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã¯ç›´æ¥ç·¨é›†ã—ãªã„ã§ãã ã•ã„ã€‚"
    read -p "æœ¬å½“ã«ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${RED}âŒ ã‚³ãƒŸãƒƒãƒˆã‚’ä¸­æ­¢ã—ã¾ã—ãŸ${NC}"
        exit 1
    fi
fi

# 3. Validate specifications
if [ "$SPEC_CHANGED" = true ]; then
    echo -e "${BLUE}ğŸ“‹ ä»•æ§˜æ›¸ã®æ¤œè¨¼ä¸­...${NC}"
    
    # Find all changed spec files
    for spec_file in $(git diff --cached --name-only | grep "specs/.*\.yaml\|specs/.*\.yml"); do
        if [ -f "$spec_file" ]; then
            echo "  Validating: $spec_file"
            node scripts/validators/validate-spec.js "$spec_file" || {
                echo -e "${RED}âŒ ä»•æ§˜æ›¸ã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ: $spec_file${NC}"
                exit 1
            }
        fi
    done
    
    echo -e "${GREEN}âœ… ä»•æ§˜æ›¸ã®æ¤œè¨¼å®Œäº†${NC}"
    
    # 4. Regenerate code if specs changed
    echo -e "${BLUE}ğŸ”§ ã‚³ãƒ¼ãƒ‰ç”Ÿæˆä¸­...${NC}"
    make generate || {
        echo -e "${RED}âŒ ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ${NC}"
        exit 1
    }
    
    # Check if generated files have changes
    if [ -n "$(git diff generated/)" ]; then
        echo -e "${YELLOW}ğŸ“¦ ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã«å¤‰æ›´ãŒã‚ã‚Šã¾ã™${NC}"
        echo "ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸï¼š"
        git diff --name-only generated/
        
        # Add generated files to commit
        git add generated/
        echo -e "${GREEN}âœ… ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ${NC}"
    fi
fi

# 5. Run type checks
echo -e "${BLUE}ğŸ” å‹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­...${NC}"

# Check backend (Go)
if [ -d "generated/backend" ]; then
    echo "  Goå‹ãƒã‚§ãƒƒã‚¯..."
    cd generated/backend
    if command -v go >/dev/null 2>&1; then
        go fmt ./... || true
        go vet ./... || {
            echo -e "${RED}âŒ Goå‹ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ${NC}"
            cd ../..
            exit 1
        }
    fi
    cd ../..
fi

# Check frontend (TypeScript)
if [ -d "generated/frontend" ] && [ -f "generated/frontend/package.json" ]; then
    echo "  TypeScriptå‹ãƒã‚§ãƒƒã‚¯..."
    cd generated/frontend
    if command -v npm >/dev/null 2>&1; then
        npm run type-check 2>/dev/null || {
            echo -e "${YELLOW}âš ï¸  TypeScriptå‹ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæœªè¨­å®šï¼‰${NC}"
        }
    fi
    cd ../..
fi

echo -e "${GREEN}âœ… å‹ãƒã‚§ãƒƒã‚¯å®Œäº†${NC}"

# 6. Check for consistency
echo -e "${BLUE}ğŸ” ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯...${NC}"

# Check if all required files exist
REQUIRED_FILES=(
    "api-spec-system/README.md"
    "api-spec-system/Makefile"
    "CLAUDE.md"
)

for file in "${REQUIRED_FILES[@]}"; do
    if [ ! -f "$file" ]; then
        echo -e "${YELLOW}âš ï¸  æ¨å¥¨ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $file${NC}"
    fi
done

# 7. Final validation
echo -e "${BLUE}ğŸ¯ æœ€çµ‚æ¤œè¨¼...${NC}"

# Check commit message
COMMIT_MSG_FILE=".git/COMMIT_EDITMSG"
if [ -f "$COMMIT_MSG_FILE" ]; then
    COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")
    
    # Check for spec-related keywords if specs were changed
    if [ "$SPEC_CHANGED" = true ]; then
        if ! echo "$COMMIT_MSG" | grep -qiE "spec|api|ä»•æ§˜|specification"; then
            echo -e "${YELLOW}âš ï¸  ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«APIä»•æ§˜ã®å¤‰æ›´ã«ã¤ã„ã¦è¨˜è¼‰ã—ã¦ãã ã•ã„${NC}"
        fi
    fi
fi

echo "========================================="
echo -e "${GREEN}âœ… ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸï¼${NC}"
echo -e "${GREEN}ğŸ“ ã‚³ãƒŸãƒƒãƒˆã‚’ç¶šè¡Œã—ã¾ã™...${NC}"

exit 0