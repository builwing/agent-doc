# ClaudeCode Task Templates
# APIä»•æ§˜ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¿ã‚¹ã‚¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯setup.shå®Ÿè¡Œæ™‚ã«.claude/ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã™

templates:
  # æ–°ã—ã„APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¿½åŠ 
  add_api_endpoint:
    name: "æ–°ã—ã„APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ "
    steps:
      - action: "analyze"
        description: "è¦æ±‚ã‚’åˆ†æ"
        commands:
          - "echo 'ğŸ“‹ è¦æ±‚ã‚’åˆ†æä¸­...'"
          - "ls -la specs/"
      
      - action: "edit_spec"
        description: "ä»•æ§˜æ›¸ã‚’ç·¨é›†"
        file_pattern: "specs/**/*.yaml"
        template: |
          paths:
            /api/v1/{{resource}}:
              {{method}}:
                tags:
                  - {{tag}}
                summary: {{summary}}
                operationId: {{operationId}}
                x-go-zero:
                  handler: {{handler}}Handler
                  logic: {{handler}}Logic
                x-frontend:
                  swr: {{useSWR}}
                  revalidate: {{revalidateTime}}
                x-mobile:
                  offline: {{offlineSupport}}
                  cacheTime: {{cacheTime}}
      
      - action: "validate"
        description: "ä»•æ§˜ã‚’æ¤œè¨¼"
        commands:
          - "make validate"
      
      - action: "generate"
        description: "ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ"
        commands:
          - "make generate"
      
      - action: "implement"
        description: "ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…"
        files:
          - "generated/backend/internal/logic/{{operationId}}logic.go"
      
      - action: "test"
        description: "ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
        commands:
          - "make test-backend"
          - "make test-frontend"

  # æ—¢å­˜APIæ›´æ–°
  update_api_endpoint:
    name: "æ—¢å­˜ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æ›´æ–°"
    steps:
      - action: "check_impact"
        description: "å½±éŸ¿ç¯„å›²ã‚’ç¢ºèª"
        commands:
          - "grep -r '{{operationId}}' generated/"
      
      - action: "backup"
        description: "ç¾åœ¨ã®å®Ÿè£…ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—"
        commands:
          - "cp -r generated/ generated.backup/"
      
      - action: "update_spec"
        description: "ä»•æ§˜æ›¸ã‚’æ›´æ–°"
        file_pattern: "specs/**/*.yaml"
      
      - action: "validate_breaking"
        description: "ç ´å£Šçš„å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯"
        commands:
          - "make validate"
          - "echo 'âš ï¸  ç ´å£Šçš„å¤‰æ›´ãŒã‚ã‚‹å ´åˆã¯ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã‚’æ¤œè¨ã—ã¦ãã ã•ã„'"
      
      - action: "regenerate"
        description: "ã‚³ãƒ¼ãƒ‰ã‚’å†ç”Ÿæˆ"
        commands:
          - "make generate"
      
      - action: "update_impl"
        description: "å®Ÿè£…ã‚’æ›´æ–°"
        files:
          - "generated/backend/internal/logic/*.go"
      
      - action: "test_all"
        description: "å…¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
        commands:
          - "make test-backend"
          - "make test-frontend"
          - "make test-mobile"

  # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ 
  add_validation:
    name: "ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ "
    steps:
      - action: "locate_schema"
        description: "ã‚¹ã‚­ãƒ¼ãƒã‚’ç‰¹å®š"
        commands:
          - "grep -r '{{schemaName}}' specs/"
      
      - action: "add_validation"
        description: "ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ "
        template: |
          x-validation:
            frontend:
              required: {{required}}
              minLength: {{minLength}}
              maxLength: {{maxLength}}
              pattern: "{{pattern}}"
            mobile:
              required: {{required}}
              custom: "{{customValidator}}"
      
      - action: "regenerate"
        description: "ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ"
        commands:
          - "make generate"
      
      - action: "verify"
        description: "ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç¢ºèª"
        commands:
          - "cat generated/frontend/api-client.ts | grep -A 5 '{{schemaName}}Schema'"

  # èªè¨¼è¨­å®š
  setup_authentication:
    name: "èªè¨¼ã‚’è¨­å®š"
    steps:
      - action: "add_security_scheme"
        description: "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ¼ãƒ ã‚’è¿½åŠ "
        file: "specs/core/api-spec.yaml"
        template: |
          components:
            securitySchemes:
              bearerAuth:
                type: http
                scheme: bearer
                bearerFormat: JWT
      
      - action: "protect_endpoints"
        description: "ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä¿è­·"
        template: |
          security:
            - bearerAuth: []
      
      - action: "configure_middleware"
        description: "ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’è¨­å®š"
        template: |
          x-go-zero:
            jwt:
              enabled: true
              secret: ${JWT_SECRET}
            middleware:
              - auth
              - cors
      
      - action: "generate_auth"
        description: "èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ"
        commands:
          - "make generate"

  # ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
  configure_cache:
    name: "ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è¨­å®š"
    steps:
      - action: "backend_cache"
        description: "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è¨­å®š"
        template: |
          x-go-zero:
            cache:
              enabled: true
              ttl: {{ttl}}
              key: "{{cacheKey}}"
      
      - action: "frontend_cache"
        description: "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è¨­å®š"
        template: |
          x-frontend:
            swr: true
            revalidate: {{revalidateTime}}
            cache:
              tags: ["{{tag}}"]
      
      - action: "mobile_cache"
        description: "ãƒ¢ãƒã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è¨­å®š"
        template: |
          x-mobile:
            offline: true
            cacheTime: {{cacheTime}}
      
      - action: "apply"
        description: "è¨­å®šã‚’é©ç”¨"
        commands:
          - "make generate"

  # WebSocketè¿½åŠ 
  add_websocket:
    name: "WebSocketã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ "
    steps:
      - action: "define_websocket"
        description: "WebSocketã‚’å®šç¾©"
        template: |
          x-websocket:
            /ws/{{endpoint}}:
              description: {{description}}
              x-go-zero:
                handler: {{handler}}WebSocketHandler
              x-frontend:
                reconnect: true
                heartbeat: 30
              x-mobile:
                background: true
              messages:
                - name: {{messageName}}
                  direction: {{direction}}
                  schema:
                    $ref: '#/components/schemas/{{messageSchema}}'
      
      - action: "generate_ws"
        description: "WebSocketã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ"
        commands:
          - "make generate"
      
      - action: "implement_handler"
        description: "ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å®Ÿè£…"
        files:
          - "generated/backend/internal/handler/{{handler}}websockethandler.go"

  # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
  setup_error_handling:
    name: "ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¨­å®š"
    steps:
      - action: "define_errors"
        description: "ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å®šç¾©"
        template: |
          components:
            schemas:
              ErrorResponse:
                type: object
                required: [code, message]
                properties:
                  code:
                    type: integer
                  message:
                    type: string
                  details:
                    type: object
                  timestamp:
                    type: string
                    format: date-time
      
      - action: "add_error_responses"
        description: "ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿½åŠ "
        template: |
          responses:
            '400':
              description: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
              content:
                application/json:
                  schema:
                    $ref: '#/components/schemas/ErrorResponse'
            '401':
              description: èªè¨¼ã‚¨ãƒ©ãƒ¼
            '403':
              description: æ¨©é™ã‚¨ãƒ©ãƒ¼
            '404':
              description: ãƒªã‚½ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“
            '500':
              description: ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼
      
      - action: "generate_errors"
        description: "ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ"
        commands:
          - "make generate"

# ã‚¿ã‚¹ã‚¯å®Ÿè¡Œãƒ«ãƒ¼ãƒ«
execution_rules:
  # å®Ÿè¡Œå‰ãƒã‚§ãƒƒã‚¯
  pre_execution:
    - check: "spec_exists"
      command: "test -f specs/core/api-spec.yaml"
      error: "APIä»•æ§˜æ›¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    
    - check: "tools_available"
      command: "command -v make && command -v node"
      error: "å¿…è¦ãªãƒ„ãƒ¼ãƒ«ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"
  
  # å®Ÿè¡Œå¾Œãƒã‚§ãƒƒã‚¯
  post_execution:
    - check: "validation_passed"
      command: "make validate"
      error: "ä»•æ§˜ã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ"
    
    - check: "generation_complete"
      command: "test -d generated/"
      error: "ã‚³ãƒ¼ãƒ‰ç”ŸæˆãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“"

# ã‚¨ãƒ©ãƒ¼ãƒªã‚«ãƒãƒªãƒ¼
error_recovery:
  validation_failed:
    steps:
      - "echo 'âŒ ä»•æ§˜ã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ'"
      - "node scripts/validators/validate-spec.js specs/core/api-spec.yaml"
      - "echo 'ä¸Šè¨˜ã®ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„'"
  
  generation_failed:
    steps:
      - "echo 'âŒ ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ'"
      - "rm -rf generated/*"
      - "make clean"
      - "make generate"
  
  test_failed:
    steps:
      - "echo 'âŒ ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ'"
      - "make test-backend || true"
      - "make test-frontend || true"
      - "echo 'ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„'"